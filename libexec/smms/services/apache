#!/usr/bin/env bash

apache_service_list() {
	entry_function "${FUNCNAME}" "${FUNCNAME[1]}" "$@"

	SMMS_SERVICE_INIT apache2.service apache2
}

# shellcheck disable=SC2120
apache_service_cmd() {
	entry_function "${FUNCNAME}" "${FUNCNAME[1]}" "$@"

	apache_application_list
}

apache_service_name() {
	entry_function "${FUNCNAME}" "${FUNCNAME[1]}" "$@"

	echo "The Apache Web Server"
}

apache_service_info() {
	entry_function "${FUNCNAME}" "${FUNCNAME[1]}" "$@"

	applications_vv "$(apache_service_cmd)"
}

apache_service_process() {
	entry_function "${FUNCNAME}" "${FUNCNAME[1]}" "$@"

	pgrep "$1"
}

apache_service_status() {
	entry_function "${FUNCNAME}" "${FUNCNAME[1]}" "$@"

	local mods

	case "$(InitSystem)" in
	"${SMMS_INIT_OPENRC}")
		${SMMS_OPENRC_PATH}/apache2 configtest &>/dev/null && return
		;;
	"${SMMS_INIT_SYSTEMD}")
		case "$(getDistro)" in
		"${SMMS_OS_GENTOO}")
			mods="$(grep ^APACHE2_OPTS= /etc/conf.d/apache2 | cut -d\" -f2)"
			;;
		esac

		apache_application_list "${mods}" -t &>/dev/null && return
		;;
	esac

	return 1
}

#######################################
# Generate the necessary code for the monit configuration
# Arguments:
#   one command returned from the list of the xxxx_list function
# Outputs:
#   Show monit code
#######################################
apache_service_monit() {
	entry_function "${FUNCNAME}" "${FUNCNAME[1]}" "$@"

	local text name

	name="$(echo ${FUNCNAME} | cut -d_ -f1)"

	text="check process apache with pidfile /run/apache2.pid
    group www
    start program = \"${SMMS_SERVICE_CMD} restart --no-deps ${name}\"
    stop  program = \"${SMMS_SERVICE_CMD} stop --no-deps ${name}\"
#    if failed host 127.0.0.1 port {PORT}
#          protocol apache-status  dnslimit > 25% or
#                                  loglimit > 80% or
#                                  waitlimit < 20%
#          then alert
    if total cpu > {CPU_ALERT} for 5 cycles then restart
    if failed host 127.0.0.1 port 80 protocol http
       and request "/monit_token"
       for 3 cycles then restart
#    if failed host 127.0.0.1 port 443 type tcpssl protocol http
#       with timeout 15 seconds
#       then restart
    depends on apache_bin

check file apache_bin with path /usr/sbin/apache2
    group www
    if changed checksum then restart
"

	MonitMakeFile "${text}"
}
